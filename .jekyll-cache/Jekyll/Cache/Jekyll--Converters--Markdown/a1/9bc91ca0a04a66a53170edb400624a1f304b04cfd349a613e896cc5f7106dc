I"&<p>Ever wanted to quickly find, extract or modify data coming from some JSON documents on the command line? JQ is the tool you’re looking for. In the previous part of this JQ and OpenAPI Series, we learned to invoke JQ and how to extract data from JSON documents using some of its many filters. Now we will discover how to build flexible and easily reusable JQ filters by creating functions and modules and also using command line arguments.<!--more--> We will continue working on OpenAPI files, at the end of this second part, we’ll have built a multi-criteria OpenAPI search and some reusable filters, especially one that you’ll be able to reuse anytime you’ll have to deal with JQ command line parameters.</p>

<div class="card series-toc">
  <div class="card-header series-toc-title">
    <h5 id="series">JQ and OpenAPI Series</h5>
  </div>
  <div class="row series-toc_content">
    <div class="col-md-7 series-toc-summary">
      <div class="card-body">
        <p class="card-text">
JQ's <a href="https://stedolan.github.io/jq/manual/v1.6/" target="jq">documentation</a> is quite complete and there are many tutorials and Stackoverflow answers, so why bother writing this series? First reason, I regularly meet people working with APIs and/or JSON files who actually don't know JQ exists and how it could save their life (or at least their time). Second reason, I often use it with OpenAPI specification files and I found that showing how JQ can be used on such a widely adopted and familiar JSON based format could help to learn how to use it (and also writing this post actually helped me to improve my JQ skills!).
</p>
      </div>
    </div>
    <div class="col-md-5 series-toc-list">
      
      <ul class="list-group list-group-flush">
        
          
          <li class="list-group-item"><a href="/api-toolbox-jq-and-openapi-part-1-using-jq-to-extract-data-from-openapi-files/">1 - Using JQ to extract data from OpenAPI files</a></li>
          
        
          
          <li class="list-group-item active">2 - Using JQ command line arguments, functions and modules</li>
          
        
          
          <li class="list-group-item"><a href="/api-toolbox-jq-and-openapi-part-3-modifying-openapi-files-with-jq/">3 - Modifying OpenAPI files with JQ</a></li>
          
        
          
          <li class="list-group-item"><a href="/api-toolbox-jq-and-openapi-part-4-bonus-coloring-jqs-raw-output/">4 - Bonus: Coloring JQ's raw output</a></li>
          
        
        
          
          
          
        
          
          
          
        
      </ul>
    </div>
  </div>
</div>

<h1 id="get-posts-content">Get post’s content</h1>

<p>All examples shown in this post are based on JQ 1.6 and OpenAPI 3. All examples can be copied using the <span class="icon-inline icon-text" aria-label="copy button icon"><svg height="100px" width="100px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve"><path d="M14,2V0H6v2H2v18h16V2H14z M12,2v2H8V2H12z M16,18H4V4h2v2h8V4h2V18z"></path></svg></span> button and downloaded using the <span class="icon-inline icon-text" aria-label="download button icon"><svg height="100px" width="100px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve"><g><polygon points="15,11 13.6,9.6 11,12.2 11,0 9,0 9,12.2 6.4,9.6 5,11 10,16  "></polygon><polygon points="18,12 18,18 2,18 2,12 0,12 0,20 20,20 20,12  "></polygon></g></svg></span> one on code snippets. All source code can be retrieved from the <a href="https://github.com/arno-di-loreto/jq-and-openapi/" target="jq">JQ and OpenAPI post series’ github repository</a>.</p>

<div class="card card-code text-white bg-dark border-dark">
  <pre class="copy-hidden code-copy">git clone https://github.com/arno-di-loreto/jq-and-openapi/
cd jq-and-openapi
git checkout part-2

</pre>
  <div class="card-header">
    <div class="row m-0">
      <div class="col align-self-center">
        <p class="m-0 title"></p>
      </div>
      <div class="col col-auto pr-0">
        <div class="btn-group" role="group" aria-label="code snippet control">
          <a role="button" class="btn btn-secondary code-copy-btn border-0 rounded-0" aria-label="copy" data-toggle="tooltip" data-placement="top" title="Copy"><img class="btn-icon" src="/images/commons/icons/copy.svg" /></a>
          
        </div>
      </div>
    </div>
  </div>
  <div class="card-body">
    <pre class="language-bash line-numbers"><code class="code-block">[apihandyman.io]$ git clone https://github.com/arno-di-loreto/jq-and-openapi/
[apihandyman.io]$ cd jq-and-openapi
[apihandyman.io]$ git checkout part-2</code></pre>
  </div>
</div>

<h1 id="listing-operations-using-functions-and-modules">Listing operations using functions and modules</h1>

<p>In previous post, we built a filter that lists the operations available in an OpenAPI file. In this first section, we will just refactor the JQ code to make it more readable and reusable using functions and modules. The following listing shows what happens when using the new version of list-operations.jq on the demo OpenAPI file.</p>

<div class="card card-code text-white bg-dark border-dark">
  <pre class="copy-hidden code-copy">jq -r -f list-operations.jq demo-api-openapi.json

</pre>
  <div class="card-header">
    <div class="row m-0">
      <div class="col align-self-center">
        <p class="m-0 title">Same result as in part 1 but list-operations.jq has changed under the hood</p>
      </div>
      <div class="col col-auto pr-0">
        <div class="btn-group" role="group" aria-label="code snippet control">
          <a role="button" class="btn btn-secondary code-copy-btn border-0 rounded-0" aria-label="copy" data-toggle="tooltip" data-placement="top" title="Copy"><img class="btn-icon" src="/images/commons/icons/copy.svg" /></a>
          
        </div>
      </div>
    </div>
  </div>
  <div class="card-body">
    <pre class="language-bash line-numbers"><code class="code-block">[apihandyman.io]$ jq -r -f list-operations.jq demo-api-openapi.json
get     /accounts       List accounts
get     /accounts/{id}  Get an account
post    /beneficiaries  Register a beneficiary
get     /beneficiaries  List beneficiaries
delete  /beneficiaries/{id}     Delete a beneficiary (deprecated)
patch   /beneficiaries/{id}     Updates a beneficiary (deprecated)
get     /beneficiaries/{id}     Get a beneficiary
get     /sources        List transfer sources
get     /sources/{id}/destinations      List transfer source&#39;s destinations
post    /transfers      Transfer money
get     /transfers      List money transfers
get     /transfers/{id} Get a money transfer
patch   /transfers/{id}
delete  /transfers/{id} Cancel a money transfer</code></pre>
  </div>
</div>

<p>It seems nothing has changed, it still outputs operations HTTP methods, paths and summaries, but under the hood, the JQ file used has changed as shown in the following listing.</p>

<div class="card card-code text-white bg-dark border-dark">
  <div class="card-header">
    <div class="row m-0">
      <div class="col align-self-center">
        <p class="m-0 title">list-operations.jq</p>
      </div>
      <div class="col col-auto pr-0">
        <div class="btn-group" role="group" aria-label="code file controls">
          <a role="button" class="btn btn-secondary border-0 rounded-0" aria-label="download file" target="_blank" href="/code/api-toolbox-jq-and-openapi/part-2/list-operations.jq" data-toggle="tooltip" data-placement="top" title="Download"><img class="btn-icon" src="/images/commons/icons/download.svg" /></a>
          <a role="button" class="btn btn-secondary code-copy-btn border-0 rounded-0" aria-label="copy" data-toggle="tooltip" data-placement="top" title="Copy"><img class="btn-icon" src="/images/commons/icons/copy.svg" /></a>
          
        </div>
      </div>
    </div>
  </div>
  <div class="card-body">
    <pre class="language-jq line-numbers code-copy"><code class="code-block">include "module-openapi"; # Imports module-openapi.jq file

oas_operations | # Function coming from module-openapi.jq file
oas_operations_to_text  # Function coming from module-openapi.jq file</code></pre>
  </div>
</div>

<p>Let’s see how it was created, we’ll discover functions and then modules.</p>

<h2 id="creating-functions">Creating functions</h2>

<p>As a reminder, here’ the previous version of the <code>list-operations.jq</code> file we created in previous part. It is composed of three steps. Steps 1 and 2 build an array of operation object containing a (HTTP) method, path, summary and deprecated indicator. Step 3 aims to print this array as tab separated text.</p>

<div class="card card-code text-white bg-dark border-dark">
  <div class="card-header">
    <div class="row m-0">
      <div class="col align-self-center">
        <p class="m-0 title">list-operations-original.jq</p>
      </div>
      <div class="col col-auto pr-0">
        <div class="btn-group" role="group" aria-label="code file controls">
          <a role="button" class="btn btn-secondary border-0 rounded-0" aria-label="download file" target="_blank" href="/code/api-toolbox-jq-and-openapi/part-2/list-operations-original.jq" data-toggle="tooltip" data-placement="top" title="Download"><img class="btn-icon" src="/images/commons/icons/download.svg" /></a>
          <a role="button" class="btn btn-secondary code-copy-btn border-0 rounded-0" aria-label="copy" data-toggle="tooltip" data-placement="top" title="Copy"><img class="btn-icon" src="/images/commons/icons/copy.svg" /></a>
          <a role="button" class="btn btn-secondary border-0 rounded-0 code-expandcollapse-btn" aria-label="expand or shrink" onclick="expandCollapseCode(this)" data-toggle="tooltip" data-placement="top" title="Expand/Shrink"><img class="btn-icon" src="/images/commons/icons/maximize.svg" /></a>
        </div>
      </div>
    </div>
  </div>
  <div class="card-body">
    <pre class="language-jq line-numbers code-collapsed code-copy"><code class="code-block"># 1 - Selects paths objects
#--------------------------
# returns [{key: path, value: path value}]
.paths # Selects the paths property content
| to_entries # Transforms
             # { "/resources": { "get": {operation data}}} 
             # to 
             # [ { "key": "/resources", 
             #     "value": { "get": {operation data}} ]
| map(select(.key | test("^x-") | not)) # Gets rid of x-tensions
# 2 - Creates an array of operations
#-----------------------------------
# returns [{path, method, summary, deprecated}]
| map ( # Applies a transformation to each element
  .key as $path # Stores the path value (.key) 
                  # in a variable ($path) for later use
  | .value # Keeps only the path's content 
           # { "get": {operation data}}
  | to_entries # Transforms 
               # { "get": {operation data}}
               # to
               # [ { "key": "get", 
               #     "value": {operation data}} ]
  | map( # Applies a transformation to each element
    select( # Keeps only elements for which the following is true
      # With IN, which returns true if the value is one of its
      # parameters, we can get rid of x- , parameters
      # description and summary properties
      .key | IN("get", "put", "post", "delete", 
         "options", "head", "patch", "trace")
    )
    | # Creates a new JSON object
    {
      method: .key,
      path: $path, # Using the variable defined on line 4
      summary: .value.summary?,
      deprecated: .value.deprecated?
    }
  )[] # Flattens array to avoid having an array 
      # of array of {path, method, summary, deprecated}
) # Now we have an array of {path, method, summary, deprecated}
# 3 - Outputs tab separated raw text
#-----------------------------------
| map( # Applies a transformation to each element
  .method + "\t" + 
  .path + "\t" + 
  .summary + 
  (if .deprecated then " (deprecated)" else "" end)
)
[] # Flattens array for raw output</code></pre>
  </div>
</div>

<p>Let’s focus on step 3, which is shown below, and build a function that does the same job.</p>

<div class="card card-code text-white bg-dark border-dark">
  <div class="card-header">
    <div class="row m-0">
      <div class="col align-self-center">
        <p class="m-0 title">We will create a function for step 3</p>
      </div>
      <div class="col col-auto pr-0">
        <div class="btn-group" role="group" aria-label="code file controls">
          <a role="button" class="btn btn-secondary border-0 rounded-0" aria-label="download file" target="_blank" href="/code/api-toolbox-jq-and-openapi/part-2/list-operations-original.jq" data-toggle="tooltip" data-placement="top" title="Download"><img class="btn-icon" src="/images/commons/icons/download.svg" /></a>
          <a role="button" class="btn btn-secondary code-copy-btn border-0 rounded-0" aria-label="copy" data-toggle="tooltip" data-placement="top" title="Copy"><img class="btn-icon" src="/images/commons/icons/copy.svg" /></a>
          
        </div>
      </div>
    </div>
  </div>
  <div class="card-body">
    <pre class="language-jq line-numbers code-copy" data-start="42"><code class="code-block"># 3 - Outputs tab separated raw text
#-----------------------------------
| map( # Applies a transformation to each element
  .method + "\t" + 
  .path + "\t" + 
  .summary + 
  (if .deprecated then " (deprecated)" else "" end)
)
[] # Flattens array for raw output</code></pre>
  </div>
</div>

<p>Defining a function in JQ is quite simple: at the beginning of the file, add a <code>def function_name:</code> put some filters and end by <code>;</code> and you’re done. The <code>oas_operation_to_text</code> which basically contains step 3’s filters is shown below.</p>

<div class="card card-code text-white bg-dark border-dark">
  <div class="card-header">
    <div class="row m-0">
      <div class="col align-self-center">
        <p class="m-0 title">Defining the oas_operation_to_text function</p>
      </div>
      <div class="col col-auto pr-0">
        <div class="btn-group" role="group" aria-label="code file controls">
          <a role="button" class="btn btn-secondary border-0 rounded-0" aria-label="download file" target="_blank" href="/code/api-toolbox-jq-and-openapi/part-2/list-operations-with-to-text-function.jq" data-toggle="tooltip" data-placement="top" title="Download"><img class="btn-icon" src="/images/commons/icons/download.svg" /></a>
          <a role="button" class="btn btn-secondary code-copy-btn border-0 rounded-0" aria-label="copy" data-toggle="tooltip" data-placement="top" title="Copy"><img class="btn-icon" src="/images/commons/icons/copy.svg" /></a>
          
        </div>
      </div>
    </div>
  </div>
  <div class="card-body">
    <pre class="language-jq line-numbers code-copy"><code class="code-block">def oas_operations_to_text: # Defining a function that
                            # Prints operations as raw text
  map( # Applies a transformation to each element
    .method + "\t" + 
    .path + "\t" + 
    .summary + 
    (if .deprecated then " (deprecated)" else "" end)
  )
  [] # Flattens array for raw output
; # oas_operations_to_text function's end
</code></pre>
  </div>
</div>

<p>If defining a function in JQ is quite simple, using it is even more simple. Just call it like any regular JQ filter. The following listing shows how step 3’s code has been replaced by the new <code>oas_operation_to_text</code> custom filter which is on top of the file.</p>

<div class="card card-code text-white bg-dark border-dark">
  <div class="card-header">
    <div class="row m-0">
      <div class="col align-self-center">
        <p class="m-0 title">Using the oas_operation_to_text function</p>
      </div>
      <div class="col col-auto pr-0">
        <div class="btn-group" role="group" aria-label="code file controls">
          <a role="button" class="btn btn-secondary border-0 rounded-0" aria-label="download file" target="_blank" href="/code/api-toolbox-jq-and-openapi/part-2/list-operations-with-to-text-function.jq" data-toggle="tooltip" data-placement="top" title="Download"><img class="btn-icon" src="/images/commons/icons/download.svg" /></a>
          <a role="button" class="btn btn-secondary code-copy-btn border-0 rounded-0" aria-label="copy" data-toggle="tooltip" data-placement="top" title="Copy"><img class="btn-icon" src="/images/commons/icons/copy.svg" /></a>
          
        </div>
      </div>
    </div>
  </div>
  <div class="card-body">
    <pre class="language-jq line-numbers code-copy" data-start="53"><code class="code-block"># 3 - Outputs tab separated raw text
#-----------------------------------
| oas_operations_to_text</code></pre>
  </div>
</div>

<p>Here’s the full modified list-operations.jq file including the <code>oas_operation_to_text</code> definition at the beginning and its calling on the last line.</p>

<div class="card card-code text-white bg-dark border-dark">
  <div class="card-header">
    <div class="row m-0">
      <div class="col align-self-center">
        <p class="m-0 title">list-operations-with-to-text-function.jq</p>
      </div>
      <div class="col col-auto pr-0">
        <div class="btn-group" role="group" aria-label="code file controls">
          <a role="button" class="btn btn-secondary border-0 rounded-0" aria-label="download file" target="_blank" href="/code/api-toolbox-jq-and-openapi/part-2/list-operations-with-to-text-function.jq" data-toggle="tooltip" data-placement="top" title="Download"><img class="btn-icon" src="/images/commons/icons/download.svg" /></a>
          <a role="button" class="btn btn-secondary code-copy-btn border-0 rounded-0" aria-label="copy" data-toggle="tooltip" data-placement="top" title="Copy"><img class="btn-icon" src="/images/commons/icons/copy.svg" /></a>
          <a role="button" class="btn btn-secondary border-0 rounded-0 code-expandcollapse-btn" aria-label="expand or shrink" onclick="expandCollapseCode(this)" data-toggle="tooltip" data-placement="top" title="Expand/Shrink"><img class="btn-icon" src="/images/commons/icons/maximize.svg" /></a>
        </div>
      </div>
    </div>
  </div>
  <div class="card-body">
    <pre class="language-jq line-numbers code-collapsed code-copy" data-line="1-10,55"><code class="code-block">def oas_operations_to_text: # Defining a function that
                            # Prints operations as raw text
  map( # Applies a transformation to each element
    .method + "\t" + 
    .path + "\t" + 
    .summary + 
    (if .deprecated then " (deprecated)" else "" end)
  )
  [] # Flattens array for raw output
; # oas_operations_to_text function's end

# 1 - Selects paths objects
#--------------------------
# returns [{key: path, value: path value}]
.paths # Selects the paths property content
| to_entries # Transforms
             # { "/resources": { "get": {operation data}}} 
             # to 
             # [ { "key": "/resources", 
             #     "value": { "get": {operation data}} ]
| map(select(.key | test("^x-") | not)) # Gets rid of x-tensions
# 2 - Creates an array of operations
#-----------------------------------
# returns [{path, method, summary, deprecated}]
| map ( # Applies a transformation to each element
  .key as $path # Stores the path value (.key) 
                  # in a variable ($path) for later use
  | .value # Keeps only the path's content 
           # { "get": {operation data}}
  | to_entries # Transforms 
               # { "get": {operation data}}
               # to
               # [ { "key": "get", 
               #     "value": {operation data}} ]
  | map( # Applies a transformation to each element
    select( # Keeps only elements for which the following is true
      # With IN, which returns true if the value is one of its
      # parameters, we can get rid of x- , parameters
      # description and summary properties
      .key | IN("get", "put", "post", "delete", 
         "options", "head", "patch", "trace")
    )
    | # Creates a new JSON object
    {
      method: .key,
      path: $path, # Using the variable defined on line 4
      summary: .value.summary?,
      deprecated: .value.deprecated?
    }
  )[] # Flattens array to avoid having an array 
      # of array of {path, method, summary, deprecated}
) # Now we have an array of {path, method, summary, deprecated}
# 3 - Outputs tab separated raw text
#-----------------------------------
| oas_operations_to_text</code></pre>
  </div>
</div>

<p>That’s great, using functions big JQ filters are far more readable. But what about being able to reuse these functions?</p>

<h2 id="creating-a-module-with-reusable-functions">Creating a module with reusable functions</h2>

<p>Creating JQ <em>modules</em> that define reusable functions is, again, quite simple. Just put some functions in a JQ file and you’re done. The following listing shows a <code>module-openapi.jq</code> module file defining two functions. There’s the <code>oas_operation_to_text</code> we have just created and also an <code>oas_operations</code> which do the same as steps 1 and 2 of the <code>list-operations.jq</code> file (returning an array of operations). Note that there’s a light modification (line 43/44), this function returns also the <code>input_filename</code> and the original value of each operations (for a later use) besides its HTTP method, path, summary and deprecated flag.</p>

<div class="card card-code text-white bg-dark border-dark">
  <div class="card-header">
    <div class="row m-0">
      <div class="col align-self-center">
        <p class="m-0 title">module-openapi.jq</p>
      </div>
      <div class="col col-auto pr-0">
        <div class="btn-group" role="group" aria-label="code file controls">
          <a role="button" class="btn btn-secondary border-0 rounded-0" aria-label="download file" target="_blank" href="/code/api-toolbox-jq-and-openapi/part-2/module-openapi.jq" data-toggle="tooltip" data-placement="top" title="Download"><img class="btn-icon" src="/images/commons/icons/download.svg" /></a>
          <a role="button" class="btn btn-secondary code-copy-btn border-0 rounded-0" aria-label="copy" data-toggle="tooltip" data-placement="top" title="Copy"><img class="btn-icon" src="/images/commons/icons/copy.svg" /></a>
          <a role="button" class="btn btn-secondary border-0 rounded-0 code-expandcollapse-btn" aria-label="expand or shrink" onclick="expandCollapseCode(this)" data-toggle="tooltip" data-placement="top" title="Expand/Shrink"><img class="btn-icon" src="/images/commons/icons/maximize.svg" /></a>
        </div>
      </div>
    </div>
  </div>
  <div class="card-body">
    <pre class="language-jq line-numbers code-collapsed code-copy"><code class="code-block"># This is a reusable JQ module defining useful
# OpenAPI specification (OAS) processing functions

def oas_operations: # Defining a listoperations function
                    # returning {path, method, summary, original}
  # 1 - Selects paths objects
  #--------------------------
  # returns [{key: path, value: path value}]
  .paths # Selects the paths property content
  | to_entries # Transforms
              # { "/resources": { "get": {operation data}}} 
              # to 
              # [ { "key": "/resources", 
              #     "value": { "get": {operation data}} ]
  | map(select(.key | test("^x-") | not)) # Gets rid of x-tensions
  # 2 - Creates an array of operations
  #-----------------------------------
  # returns [{path, method, summary, deprecated}]
  | map ( # Applies a transformation to each element
    .key as $path # Stores the path value (.key) 
                    # in a variable ($path) for later use
    | .value # Keeps only the path's content 
            # { "get": {operation data}}
    | to_entries # Transforms 
                # { "get": {operation data}}
                # to
                # [ { "key": "get", 
                #     "value": {operation data}} ]
    | map( # Applies a transformation to each element
      select( # Keeps only elements for which the following is true
        # With IN, which returns true if the value is one of its
        # parameters, we can get rid of x- , parameters
        # description and summary properties
        .key | IN("get", "put", "post", "delete", 
          "options", "head", "patch", "trace")
      )
      | # Creates a new JSON object
      {
        method: .key,
        path: $path, # Using the variable defined on line 4
        summary: .value.summary?,
        deprecated: .value.deprecated?,
        original: .value, # Keeping original value, just in case 😉
        source: input_filename # Adding source file, also just in case 😉
      }
    )[] # Flattens array to avoid having an array 
        # of array of {path, method, summary, deprecated}
  ) # Now we have an array of {path, method, summary, deprecated}
; # oas_operations function's end

def oas_operations_to_text: # Defining a function that
                            # Prints operations as raw text
  map( # Applies a transformation to each element
    .method + "\t" + 
    .path + "\t" + 
    .summary + 
    (if .deprecated then " (deprecated)" else "" end)
  )
  [] # Flattens array for raw output
; # oas_operations_to_text function's end</code></pre>
  </div>
</div>

<p>Let’s get back to the new version of <code>list-operations.jq</code> (shown below) to see how this module is actually used. The module is include with the <code>include &lt;module name without extension&gt;;</code> line. Then any functions defined in it can be used like any other regular JQ filter as shown on line 3 and 4 where <code>oas_operations</code> and <code>oas_operations_to_text</code> are used.</p>

<div class="card card-code text-white bg-dark border-dark">
  <div class="card-header">
    <div class="row m-0">
      <div class="col align-self-center">
        <p class="m-0 title">list-operations.jq</p>
      </div>
      <div class="col col-auto pr-0">
        <div class="btn-group" role="group" aria-label="code file controls">
          <a role="button" class="btn btn-secondary border-0 rounded-0" aria-label="download file" target="_blank" href="/code/api-toolbox-jq-and-openapi/part-2/list-operations.jq" data-toggle="tooltip" data-placement="top" title="Download"><img class="btn-icon" src="/images/commons/icons/download.svg" /></a>
          <a role="button" class="btn btn-secondary code-copy-btn border-0 rounded-0" aria-label="copy" data-toggle="tooltip" data-placement="top" title="Copy"><img class="btn-icon" src="/images/commons/icons/copy.svg" /></a>
          
        </div>
      </div>
    </div>
  </div>
  <div class="card-body">
    <pre class="language-jq line-numbers code-copy"><code class="code-block">include "module-openapi"; # Imports module-openapi.jq file

oas_operations | # Function coming from module-openapi.jq file
oas_operations_to_text  # Function coming from module-openapi.jq file</code></pre>
  </div>
</div>

<h2 id="managing-modules-locations">Managing modules locations</h2>

<div class="card card-code card-bash text-white bg-dark border-dark">
  <div class="card-header">
    <div class="row m-0">
      <div class="col align-self-center">
        <p class="m-0 title">Managing JQ modules location</p>
      </div>
      <div class="col col-auto pr-0">
        <div class="btn-group" role="group" aria-label="bash session player controls">
          
        </div>
      </div>
    </div>
  </div>
  <div class="card-body bash-player">
    <asciinema-player id="player" title="Managing JQ modules location" author="Arnaud Lauret" rows="24" cols="125" src="/code/api-toolbox-jq-and-openapi/part-2/module-location.cast"></asciinema-player>
  </div>
</div>

<p>The following listings shows different ways of managing reusable modules location with JQ (see <a href="https://stedolan.github.io/jq/manual/#Modules">modules</a> in the JQ’s documentation for a complete description of what can be done).
It starts by a a first command done inside the <code>jq-and-openapi</code> folder.
It simply returns the first operation’s summary of the <code>demo-api-openapi.json</code> file using the <code>oas_operations[0]</code> filter composed of the <code>oas_operations</code> function and the <code>[]</code> array filter.
As you can see, there’s no need to create a JQ file to use a module, just use the <code>include</code> directive in the <code>'&lt;filter&gt;'</code> argument on the command line.
Then we go a level up, and obviously redoing the same exact command does not work anymore: the <code>module-openapi.jq</code> cannot be found in the current folder as it is in the <code>jq-and-openapi</code> one.
Hopefully, you can use the <code>-L &lt;path list&gt;</code> argument to tell JQ where to look for modules.</p>

<div class="card card-code text-white bg-dark border-dark">
  <pre class="copy-hidden code-copy">jq -r &#39;include &quot;module-openapi&quot;; oas_operations[0].summary&#39; demo-api-openapi.json
cd ..
jq -r &#39;include &quot;module-openapi&quot;; oas_operations[0].summary&#39; jq-and-openapi/demo-api-openapi.json
jq -r -L jq-and-openapi &#39;include &quot;module-openapi&quot;; oas_operations[0].summary&#39; jq-and-openapi/demo-api-openapi.json

</pre>
  <div class="card-header">
    <div class="row m-0">
      <div class="col align-self-center">
        <p class="m-0 title">Indicating where to find modules with -L argument</p>
      </div>
      <div class="col col-auto pr-0">
        <div class="btn-group" role="group" aria-label="code snippet control">
          <a role="button" class="btn btn-secondary code-copy-btn border-0 rounded-0" aria-label="copy" data-toggle="tooltip" data-placement="top" title="Copy"><img class="btn-icon" src="/images/commons/icons/copy.svg" /></a>
          
        </div>
      </div>
    </div>
  </div>
  <div class="card-body">
    <pre class="language-bash line-numbers"><code class="code-block">[apihandyman.io]$ jq -r &#39;include &quot;module-openapi&quot;; oas_operations[0].summary&#39; demo-api-openapi.json
List accounts
[apihandyman.io]$ cd ..
[apihandyman.io]$ jq -r &#39;include &quot;module-openapi&quot;; oas_operations[0].summary&#39; jq-and-openapi/demo-api-openapi.json
jq: error: module not found: module-openapi

jq: 1 compile error
[apihandyman.io]$ jq -r -L jq-and-openapi &#39;include &quot;module-openapi&quot;; oas_operations[0].summary&#39; jq-and-openapi/demo-api-openapi.json
List accounts</code></pre>
  </div>
</div>

<p>If there are modules that you use extensively, it would be interesting to put them in a <code>~/.jq</code> folder. Therefore, no longer need for the <code>-L</code> argument as shown below. JQ looks for the modules mentioned in <code>include</code> directives in this folder automatically.</p>

<div class="card card-code text-white bg-dark border-dark">
  <pre class="copy-hidden code-copy">mkdir ~/.jq
cp jq-and-openapi/module-openapi.jq ~/.jq
jq -r &#39;include &quot;module-openapi&quot;; oas_operations[0].summary&#39; jq-and-openapi/demo-api-openapi.json

</pre>
  <div class="card-header">
    <div class="row m-0">
      <div class="col align-self-center">
        <p class="m-0 title">Using ~/.jq default folder to store modules</p>
      </div>
      <div class="col col-auto pr-0">
        <div class="btn-group" role="group" aria-label="code snippet control">
          <a role="button" class="btn btn-secondary code-copy-btn border-0 rounded-0" aria-label="copy" data-toggle="tooltip" data-placement="top" title="Copy"><img class="btn-icon" src="/images/commons/icons/copy.svg" /></a>
          
        </div>
      </div>
    </div>
  </div>
  <div class="card-body">
    <pre class="language-bash line-numbers"><code class="code-block">[apihandyman.io]$ mkdir ~/.jq
[apihandyman.io]$ cp jq-and-openapi/module-openapi.jq ~/.jq
[apihandyman.io]$ jq -r &#39;include &quot;module-openapi&quot;; oas_operations[0].summary&#39; jq-and-openapi/demo-api-openapi.json
List accounts</code></pre>
  </div>
</div>

<p>Note that <code>~/.jq</code> can also be a file. In that case, you don’t even need to <code>include</code> anything, as shown below. Any function defined in this file is usable inside any of your filters. I personally do not recommend to do this because that makes your filters dependencies invisible (and can also result in a quite huge unmaintainable <code>.jq</code> file).</p>

<div class="card card-code text-white bg-dark border-dark">
  <pre class="copy-hidden code-copy">rm -rf ~/.jq
cp jq-and-openapi/module-openapi.jq ~/.jq
jq -r &#39;oas_operations[0].summary&#39; jq-and-openapi/demo-api-openapi.json

</pre>
  <div class="card-header">
    <div class="row m-0">
      <div class="col align-self-center">
        <p class="m-0 title">Using ~/.jq default file to store functions</p>
      </div>
      <div class="col col-auto pr-0">
        <div class="btn-group" role="group" aria-label="code snippet control">
          <a role="button" class="btn btn-secondary code-copy-btn border-0 rounded-0" aria-label="copy" data-toggle="tooltip" data-placement="top" title="Copy"><img class="btn-icon" src="/images/commons/icons/copy.svg" /></a>
          
        </div>
      </div>
    </div>
  </div>
  <div class="card-body">
    <pre class="language-bash line-numbers"><code class="code-block">[apihandyman.io]$ rm -rf ~/.jq
[apihandyman.io]$ cp jq-and-openapi/module-openapi.jq ~/.jq
[apihandyman.io]$ jq -r &#39;oas_operations[0].summary&#39; jq-and-openapi/demo-api-openapi.json
List accounts</code></pre>
  </div>
</div>

<h1 id="searching-operations-using-command-line-arguments">Searching operations using command line arguments</h1>

<p>Now that we have a reusable module that provides functions to list operations of an OpenAPI specification file and print them as tab separated text, let’s work on a multiple-criteria and multiple-file search.</p>

<h2 id="passing-an-argument-to-jq-filters">Passing an argument to JQ filters</h2>

<p>In order to make this search flexible, we’ll need to be able to accept search arguments coming from outside our filter in order to avoid having to modify it on each different search. Passing arguments to JQ is done with <code>--arg &lt;name&gt; &lt;value&gt;</code> as shown below. Inside the filter, you can access a <code>--arg</code> with <code>$&lt;name&gt;</code>. In this case <code>$foo</code> returns <code>bar</code>. Note also in this example the <code>-n</code> flag which is used to tell JQ to not expect any JSON input. That’s pretty useful to make demos of some JQ’s features but also to generate JSON from scratched based on some arguments values.</p>

<div class="card card-code text-white bg-dark border-dark">
  <pre class="copy-hidden code-copy">jq -n --arg foo bar &#39;{foo: $foo}&#39;

</pre>
  <div class="card-header">
    <div class="row m-0">
      <div class="col align-self-center">
        <p class="m-0 title">Passing an argument with --arg (and discovering -n flag)</p>
      </div>
      <div class="col col-auto pr-0">
        <div class="btn-group" role="group" aria-label="code snippet control">
          <a role="button" class="btn btn-secondary code-copy-btn border-0 rounded-0" aria-label="copy" data-toggle="tooltip" data-placement="top" title="Copy"><img class="btn-icon" src="/images/commons/icons/copy.svg" /></a>
          
        </div>
      </div>
    </div>
  </div>
  <div class="card-body">
    <pre class="language-bash line-numbers"><code class="code-block">[apihandyman.io]$ jq -n --arg foo bar &#39;{foo: $foo}&#39;
{
  &quot;foo&quot;: &quot;bar&quot;
}</code></pre>
  </div>
</div>

<h2 id="searching-operations-accessible-for-a-scope">Searching operations accessible for a scope</h2>

<p>The following listing shows which operations are accessible to a consumer when it is given the <code>transfer:admin</code> security scope. The scope value is provided to the filter using <code>--arg &lt;name&gt; &lt;value&gt;</code>.</p>

<div class="card card-code text-white bg-dark border-dark">
  <pre class="copy-hidden code-copy">jq -r --arg scope transfer:admin -f search-operations-using-scope.jq demo-api-openapi.json 

</pre>
  <div class="card-header">
    <div class="row m-0">
      <div class="col align-self-center">
        <p class="m-0 title">Searching operations using a given scope</p>
      </div>
      <div class="col col-auto pr-0">
        <div class="btn-group" role="group" aria-label="code snippet control">
          <a role="button" class="btn btn-secondary code-copy-btn border-0 rounded-0" aria-label="copy" data-toggle="tooltip" data-placement="top" title="Copy"><img class="btn-icon" src="/images/commons/icons/copy.svg" /></a>
          
        </div>
      </div>
    </div>
  </div>
  <div class="card-body">
    <pre class="language-bash line-numbers"><code class="code-block">[apihandyman.io]$ jq -r --arg scope transfer:admin -f search-operations-using-scope.jq demo-api-openapi.json 
post    /transfers      Transfer money
get     /transfers      List money transfers
get     /transfers/{id} Get a money transfer
delete  /transfers/{id} Cancel a money transfer</code></pre>
  </div>
</div>

<p>In an OpenAPI file, you’ll find the scopes that will grant access to an operation in its security property under a <code>{name}</code>.
According the OpenAPI Specification, <em>each name MUST correspond to a security scheme which is declared in the Security Schemes under the Components Object. If the security scheme is of type “oauth2” or “openIdConnect”, then the value is a list of scope names required for the execution. For other security scheme types, the array MUST be empty</em>.</p>

<div class="text-center">
      <figure class="figure">
        
        <img src="/images/api-toolbox-jq-and-openapi-part-2-using-jq-command-line-arguments-functions-and-modules/jq-openapi-scopes.png" class="figure-img img-fluid" />
        
        
      </figure>
    </div>

<p>For our use case, we just need to list all values (scopes) under all <code>security.{name}</code> of each operation and keep the operations for which the provided scope is found in this list. The following listing shows how this is achieved in the <code>search-operations-using-scope.jq</code>.</p>

<ul>
  <li>First (line 4), it lists existing operations using the <code>oas_operations</code> function (coming from <code>module-openapi</code> included on line 1)</li>
  <li>Then (line 5), it filters the returned operations based on their scopes by working on each of the <code>original</code> operation’s data coming from the OpenAPI file. To do so:
    <ul>
      <li>It first checks if there’s a <code>security</code> property (line 7)</li>
      <li>Then creates a list of scopes (line 9 and 10)</li>
      <li>And (line 11 to 14), if the <code>index</code> of <code>$scope</code> (provided through the <code>--arg scope &lt;value&gt;</code>) is greater than 0 (meaning it is in the list), the operation is returned</li>
    </ul>
  </li>
  <li>And finally (line 19), it prints the remaining operations as tab separated values using the <code>oas_operations_to_text</code> function (coming from <code>module-openapi</code> included on line 1)</li>
</ul>

<div class="card card-code text-white bg-dark border-dark">
  <div class="card-header">
    <div class="row m-0">
      <div class="col align-self-center">
        <p class="m-0 title">search-operations-using-scope.jq</p>
      </div>
      <div class="col col-auto pr-0">
        <div class="btn-group" role="group" aria-label="code file controls">
          <a role="button" class="btn btn-secondary border-0 rounded-0" aria-label="download file" target="_blank" href="/code/api-toolbox-jq-and-openapi/part-2/search-operations-using-scope.jq" data-toggle="tooltip" data-placement="top" title="Download"><img class="btn-icon" src="/images/commons/icons/download.svg" /></a>
          <a role="button" class="btn btn-secondary code-copy-btn border-0 rounded-0" aria-label="copy" data-toggle="tooltip" data-placement="top" title="Copy"><img class="btn-icon" src="/images/commons/icons/copy.svg" /></a>
          
        </div>
      </div>
    </div>
  </div>
  <div class="card-body">
    <pre class="language-jq line-numbers code-copy"><code class="code-block">include "module-openapi"; # Looks for a module-openapi.jq file

# Expects a --arg scope value parameter
oas_operations # Comes from module-operations.jq
| map(select( # Filters on operation scopes
    # security is not always present
    if .original.security? != null then
      # Creating an array containg all scopes
      [ .original.security | 
        map(to_entries | map(.value)[])[][] ] | 
      index( # Index returns the index of a value in array
        $scope # $scope value is provided on the command line
              # --arg scope value
      ) &#62;= 0 # If &#60; 0, it has not been found
    else
      false # No security defined, so return false
    end
  ))
| oas_operations_to_text  # Comes from module-operations.jq</code></pre>
  </div>
</div>

<p>That’s cool, but there’s a little problem. When using the <code>search-operations-using-scope.jq</code> without providing the scope value, it does not work: JQ complains that <code>$scope</code> is not defined, as shown below.</p>

<div class="card card-code text-white bg-dark border-dark">
  <pre class="copy-hidden code-copy">jq -r -f search-operations-using-scope.jq demo-api-openapi.json

</pre>
  <div class="card-header">
    <div class="row m-0">
      <div class="col align-self-center">
        <p class="m-0 title">What happens when scope is not provided</p>
      </div>
      <div class="col col-auto pr-0">
        <div class="btn-group" role="group" aria-label="code snippet control">
          <a role="button" class="btn btn-secondary code-copy-btn border-0 rounded-0" aria-label="copy" data-toggle="tooltip" data-placement="top" title="Copy"><img class="btn-icon" src="/images/commons/icons/copy.svg" /></a>
          
        </div>
      </div>
    </div>
  </div>
  <div class="card-body">
    <pre class="language-bash line-numbers"><code class="code-block">[apihandyman.io]$ jq -r -f search-operations-using-scope.jq demo-api-openapi.json
jq: error: $scope is not defined at &lt;top-level&gt;, line 12:
        $scope # $scope value is provided on the command line        
jq: 1 compile error</code></pre>
  </div>
</div>

<p>Does that mean we can’t do a multi-criteria search because it requires to be able to provide multiple <em>optional</em> parameters? Of course not, that problem can be solved.</p>

<h2 id="solving-the-command-line-argument-problem">Solving the command line argument “problem”</h2>

<div class="card card-code card-bash text-white bg-dark border-dark">
  <div class="card-header">
    <div class="row m-0">
      <div class="col align-self-center">
        <p class="m-0 title">Solving the command line argument problem</p>
      </div>
      <div class="col col-auto pr-0">
        <div class="btn-group" role="group" aria-label="bash session player controls">
          
        </div>
      </div>
    </div>
  </div>
  <div class="card-body bash-player">
    <asciinema-player id="player" title="Solving the command line argument problem" author="Arnaud Lauret" rows="24" cols="125" src="/code/api-toolbox-jq-and-openapi/part-2/solving-argument-problem.cast"></asciinema-player>
  </div>
</div>

<p>The following listing shows how to safely access a command line named argument using the <code>$ARGS.named</code> filter. If <code>$name</code> causes an error if no <code>--arg name value</code> is provided on the command line, <code>$ARGS.named['name']</code> will return <code>null</code> without causing any.</p>

<div class="card card-code text-white bg-dark border-dark">
  <pre class="copy-hidden code-copy">jq -n --arg foo hello --arg bar world &#39;{foo: $foo, bar: $bar}&#39;
jq -n --arg foo hello &#39;{foo: $foo, bar: $bar}&#39;
jq -n --arg foo hello &#39;{foo: $ARGS.named[&quot;foo&quot;], bar: $ARGS.named[&quot;bar&quot;]}&#39;

</pre>
  <div class="card-header">
    <div class="row m-0">
      <div class="col align-self-center">
        <p class="m-0 title">Using $ARGS.named</p>
      </div>
      <div class="col col-auto pr-0">
        <div class="btn-group" role="group" aria-label="code snippet control">
          <a role="button" class="btn btn-secondary code-copy-btn border-0 rounded-0" aria-label="copy" data-toggle="tooltip" data-placement="top" title="Copy"><img class="btn-icon" src="/images/commons/icons/copy.svg" /></a>
          
        </div>
      </div>
    </div>
  </div>
  <div class="card-body">
    <pre class="language-bash line-numbers"><code class="code-block">[apihandyman.io]$ jq -n --arg foo hello --arg bar world &#39;{foo: $foo, bar: $bar}&#39;
{
  &quot;foo&quot;: &quot;hello&quot;,
  &quot;bar&quot;: &quot;world&quot;
}
[apihandyman.io]$ jq -n --arg foo hello &#39;{foo: $foo, bar: $bar}&#39;
jq: error: $bar is not defined at &lt;top-level&gt;, line 1:
{foo: $foo, bar: $bar}                 
jq: 1 compile error
[apihandyman.io]$ jq -n --arg foo hello &#39;{foo: $ARGS.named[&quot;foo&quot;], bar: $ARGS.named[&quot;bar&quot;]}&#39;
{
  &quot;foo&quot;: &quot;hello&quot;,
  &quot;bar&quot;: null
}</code></pre>
  </div>
</div>

<p>That’s very handy, but what if I want to set an argument to a default value if it is not provided? I just need to use the following <code>module-args</code> module. It defines a <code>init_parameter(default_values)</code> function returning an object containing parameters set to the value coming from <code>--arg &lt;name&gt;</code> or a default value it is not provided. To do so, for each entry (key/value) of a <code>default_values</code> object parameter, it checks if the named arguments (<code>$ARGS.named</code>) contains the key and if so, sets the output value to the one provided on the command line. If not, it keeps the default one. By the way, that means that JQ functions can also use parameters besides their regular input. But note that you don’t need to prefix their name by <code>$</code> to access them.</p>

<div class="card card-code text-white bg-dark border-dark">
  <div class="card-header">
    <div class="row m-0">
      <div class="col align-self-center">
        <p class="m-0 title">module-args.jq</p>
      </div>
      <div class="col col-auto pr-0">
        <div class="btn-group" role="group" aria-label="code file controls">
          <a role="button" class="btn btn-secondary border-0 rounded-0" aria-label="download file" target="_blank" href="/code/api-toolbox-jq-and-openapi/part-2/module-args.jq" data-toggle="tooltip" data-placement="top" title="Download"><img class="btn-icon" src="/images/commons/icons/download.svg" /></a>
          <a role="button" class="btn btn-secondary code-copy-btn border-0 rounded-0" aria-label="copy" data-toggle="tooltip" data-placement="top" title="Copy"><img class="btn-icon" src="/images/commons/icons/copy.svg" /></a>
          
        </div>
      </div>
    </div>
  </div>
  <div class="card-body">
    <pre class="language-jq line-numbers code-copy"><code class="code-block"># Initializes parameters based on provided named arguments (--arg).
# If an argument is not provided, its default value is used.
# default_values example:
# {
#   argument: "default value",
#   anotherArgument: null,
# }
def init_parameters(default_values):
  default_values | 
  # Updates values for provided parameters
  with_entries(
    # $ARGS contains all --arg parameters
    if $ARGS.named[.key] != null then 
      .value = $ARGS.named[.key] 
    else 
      .value = .value
    end
  )
;</code></pre>
  </div>
</div>

<p>The following listing shows how this function can be used. Just call the <code>init_parameter</code> function with an object containing the default values and put its result in a variable (here <code>$parameter</code>) for later use (<code>$parameter.foo</code> for example). Here the default value of <code>foo</code> is <code>default foo</code> and <code>bar</code>’s is <code>null</code>. Only <code>bar</code> is provided, so the output contains <code>foo</code>’s default value and <code>bar</code> command-line-provided value.</p>

<div class="card card-code text-white bg-dark border-dark">
  <pre class="copy-hidden code-copy">jq -n --arg bar &quot;bar from command line&quot; &#39;include &quot;module-args&quot;; init_parameters({foo: &quot;default foo&quot;, bar: null}) as $parameters| {foo: $parameters.foo, bar: $parameters.bar}&#39;

</pre>
  <div class="card-header">
    <div class="row m-0">
      <div class="col align-self-center">
        <p class="m-0 title">Optional parameters with default values</p>
      </div>
      <div class="col col-auto pr-0">
        <div class="btn-group" role="group" aria-label="code snippet control">
          <a role="button" class="btn btn-secondary code-copy-btn border-0 rounded-0" aria-label="copy" data-toggle="tooltip" data-placement="top" title="Copy"><img class="btn-icon" src="/images/commons/icons/copy.svg" /></a>
          
        </div>
      </div>
    </div>
  </div>
  <div class="card-body">
    <pre class="language-bash line-numbers"><code class="code-block">[apihandyman.io]$ jq -n --arg bar &quot;bar from command line&quot; &#39;include &quot;module-args&quot;; init_parameters({foo: &quot;default foo&quot;, bar: null}) as $parameters| {foo: $parameters.foo, bar: $parameters.bar}&#39;
{
  &quot;foo&quot;: &quot;default foo&quot;,
  &quot;bar&quot;: &quot;bar from command line&quot;
}</code></pre>
  </div>
</div>

<h2 id="searching-operations-on-multiple-criteria-and-multiple-files">Searching operations on multiple criteria and multiple files</h2>

<div class="card card-code card-bash text-white bg-dark border-dark">
  <div class="card-header">
    <div class="row m-0">
      <div class="col align-self-center">
        <p class="m-0 title">Searching operations demo</p>
      </div>
      <div class="col col-auto pr-0">
        <div class="btn-group" role="group" aria-label="bash session player controls">
          
        </div>
      </div>
    </div>
  </div>
  <div class="card-body bash-player">
    <asciinema-player id="player" title="Searching operations demo" author="Arnaud Lauret" rows="24" cols="125" src="/code/api-toolbox-jq-and-openapi/part-2/search-demo.cast"></asciinema-player>
  </div>
</div>

<p>Now that we know how to provide multiple optional parameters, let’s do a multi-criteria search. The following listing shows the <code>get</code> operations on paths containing <code>sources</code> across all available <code>*.json</code> files. The first value on each line is the filename (limited to 20 characters).</p>

<div class="card card-code text-white bg-dark border-dark">
  <pre class="copy-hidden code-copy">jq --arg path_contains sources --arg method get -r -f search-operations.jq *.json

</pre>
  <div class="card-header">
    <div class="row m-0">
      <div class="col align-self-center">
        <p class="m-0 title">Operations on path containing source with method get</p>
      </div>
      <div class="col col-auto pr-0">
        <div class="btn-group" role="group" aria-label="code snippet control">
          <a role="button" class="btn btn-secondary code-copy-btn border-0 rounded-0" aria-label="copy" data-toggle="tooltip" data-placement="top" title="Copy"><img class="btn-icon" src="/images/commons/icons/copy.svg" /></a>
          
        </div>
      </div>
    </div>
  </div>
  <div class="card-body">
    <pre class="language-bash line-numbers"><code class="code-block">[apihandyman.io]$ jq --arg path_contains sources --arg method get -r -f search-operations.jq *.json
[demo-another-api-swa]  get     /resources
[demo-api-openapi.jso]  get     /sources        List transfer sources
[demo-api-openapi.jso]  get     /sources/{id}/destinations      List transfer source&#39;s destinations</code></pre>
  </div>
</div>

<p>Here’s the <code>search-operations.jq</code> file who does that. It reuses functions we have seen before, <code>oas_operations</code> from the <code>module_openapi.jq</code> file and <code>init_parameters</code> from the <code>module-args.jq</code> file. It also uses new functions <code>filter_operations</code>, <code>default_filters</code>, <code>print_oas_operations</code> and <code>default_print_parameters</code> from <code>module-openapi-search.jq</code>. There are 3 steps: getting operations data, filtering them and finally printing them. There’s nothing new on the first step, we already have used this function. Let’s see what is happening on the second and after that the third step.</p>

<div class="card card-code text-white bg-dark border-dark">
  <div class="card-header">
    <div class="row m-0">
      <div class="col align-self-center">
        <p class="m-0 title">search-operations.jq</p>
      </div>
      <div class="col col-auto pr-0">
        <div class="btn-group" role="group" aria-label="code file controls">
          <a role="button" class="btn btn-secondary border-0 rounded-0" aria-label="download file" target="_blank" href="/code/api-toolbox-jq-and-openapi/part-2/search-operations.jq" data-toggle="tooltip" data-placement="top" title="Download"><img class="btn-icon" src="/images/commons/icons/download.svg" /></a>
          <a role="button" class="btn btn-secondary code-copy-btn border-0 rounded-0" aria-label="copy" data-toggle="tooltip" data-placement="top" title="Copy"><img class="btn-icon" src="/images/commons/icons/copy.svg" /></a>
          
        </div>
      </div>
    </div>
  </div>
  <div class="card-body">
    <pre class="language-jq line-numbers code-copy"><code class="code-block">include "module-openapi";
include "module-args";
include "module-openapi-search";

# Gets operations data
oas_operations
# Filters operations
| filter_oas_operations(init_parameters(default_filters))
# Prints operations
| print_oas_operations(init_parameters(default_print_parameters).format)</code></pre>
  </div>
</div>

<p>The following listing shows the new functions used to filter operations. The <code>default_filters</code> only returns the search filters default value to be used in conjunction with <code>init_parameters</code> and so get cleans values from optional command line arguments. The <code>filter_oas_operation</code> expects a <code>filter</code> object whose structure is the same as the one returned by default filters. This operations runs a <code>map(select())</code> on the operations list. Each filter is triggered if <code>filters.&lt;name&gt;</code> is not null. There’s nothing really new regarding JQ’s filters besides line 41. The filtering on paths is done using the <code>contains</code> filter which we hadn’t seen before.</p>

<div class="card card-code text-white bg-dark border-dark">
  <div class="card-header">
    <div class="row m-0">
      <div class="col align-self-center">
        <p class="m-0 title">Filtering operations (module-openapi-search.jq)</p>
      </div>
      <div class="col col-auto pr-0">
        <div class="btn-group" role="group" aria-label="code file controls">
          <a role="button" class="btn btn-secondary border-0 rounded-0" aria-label="download file" target="_blank" href="/code/api-toolbox-jq-and-openapi/part-2/module-openapi-search.jq" data-toggle="tooltip" data-placement="top" title="Download"><img class="btn-icon" src="/images/commons/icons/download.svg" /></a>
          <a role="button" class="btn btn-secondary code-copy-btn border-0 rounded-0" aria-label="copy" data-toggle="tooltip" data-placement="top" title="Copy"><img class="btn-icon" src="/images/commons/icons/copy.svg" /></a>
          <a role="button" class="btn btn-secondary border-0 rounded-0 code-expandcollapse-btn" aria-label="expand or shrink" onclick="expandCollapseCode(this)" data-toggle="tooltip" data-placement="top" title="Expand/Shrink"><img class="btn-icon" src="/images/commons/icons/maximize.svg" /></a>
        </div>
      </div>
    </div>
  </div>
  <div class="card-body">
    <pre class="language-jq line-numbers code-collapsed code-copy" data-start="3"><code class="code-block"># Available filters and their default values
# To be used with init_parameters
def default_filters:
{
  deprecated: null,
  method: null,
  code: null,
  scope: null,
  path_contains: null
};

# Filters operations coming from oas_operations
# Each filter is used only if corresponding filters.&#60;name&#62; parameter is provided
def filter_oas_operations(filters):
  map(
    select(
    # Filters on deprecated
    (filters.deprecated == null or 
      (.deprecated | tostring) == filters.deprecated) and
    # Filters on HTTP method
    (filters.method == null or 
      .method == filters.method) and
    # Filters on HTTP status code
    (filters.code == null or 
      (.original.responses | has(filters.code))) and
    # Filters on security scope
    (filters.scope == null or
      (if .value.security? != null then
        [ .value.security | 
          map(to_entries | 
          map(.value)[])[][]] | 
        index(filters.scope) &#62;= 0
      else
        false
      end)
    ) and
    # Filters on path
    (filters.path_contains == null or 
      (.path | contains(filters.path_contains))
    )
  )
);
</code></pre>
  </div>
</div>

<p>The following listing shows the new functions used to print the operations. It uses the same mechanism as the filter functions regarding the command line arguments.</p>

<div class="card card-code text-white bg-dark border-dark">
  <div class="card-header">
    <div class="row m-0">
      <div class="col align-self-center">
        <p class="m-0 title">Printing operations (module-openapi-search.jq)</p>
      </div>
      <div class="col col-auto pr-0">
        <div class="btn-group" role="group" aria-label="code file controls">
          <a role="button" class="btn btn-secondary border-0 rounded-0" aria-label="download file" target="_blank" href="/code/api-toolbox-jq-and-openapi/part-2/module-openapi-search.jq" data-toggle="tooltip" data-placement="top" title="Download"><img class="btn-icon" src="/images/commons/icons/download.svg" /></a>
          <a role="button" class="btn btn-secondary code-copy-btn border-0 rounded-0" aria-label="copy" data-toggle="tooltip" data-placement="top" title="Copy"><img class="btn-icon" src="/images/commons/icons/copy.svg" /></a>
          <a role="button" class="btn btn-secondary border-0 rounded-0 code-expandcollapse-btn" aria-label="expand or shrink" onclick="expandCollapseCode(this)" data-toggle="tooltip" data-placement="top" title="Expand/Shrink"><img class="btn-icon" src="/images/commons/icons/maximize.svg" /></a>
        </div>
      </div>
    </div>
  </div>
  <div class="card-body">
    <pre class="language-jq line-numbers code-collapsed code-copy" data-start="46"><code class="code-block"># Same as oas_operations_to_text but with source
def oas_operations_to_text_with_source: 
  map( # Applies a transformation to each element
    "[" + .source[0:20] + "]\t" +
    .method + "\t" + 
    .path + "\t" + 
    .summary + 
    (if .deprecated then " (deprecated)" else "" end)
  )
  [] # Flattens array for raw output
; # oas_operations_to_text function's end

# To be used with init_parameters
def default_print_parameters:
{
  format: "text_with_source"
  # All values: 
  #  text_with_source, text_without_source, json_flat or null for json
};

# Prints oas_operations (filtered or not) in various format
def print_oas_operations(format):
  if format == "text_with_source" then
      oas_operations_to_text_with_source
  elif format == "text_without_source" then
      oas_operations_to_text
  elif format == "json_flat" then
    .[] # Flattening for multifiles, pipe result into a jq -s
  else
    .
  end
;
</code></pre>
  </div>
</div>

<p>Here’s the full file:</p>

<div class="card card-code text-white bg-dark border-dark">
  <div class="card-header">
    <div class="row m-0">
      <div class="col align-self-center">
        <p class="m-0 title">Filtering operations (module-openapi-search.jq)</p>
      </div>
      <div class="col col-auto pr-0">
        <div class="btn-group" role="group" aria-label="code file controls">
          <a role="button" class="btn btn-secondary border-0 rounded-0" aria-label="download file" target="_blank" href="/code/api-toolbox-jq-and-openapi/part-2/module-openapi-search.jq" data-toggle="tooltip" data-placement="top" title="Download"><img class="btn-icon" src="/images/commons/icons/download.svg" /></a>
          <a role="button" class="btn btn-secondary code-copy-btn border-0 rounded-0" aria-label="copy" data-toggle="tooltip" data-placement="top" title="Copy"><img class="btn-icon" src="/images/commons/icons/copy.svg" /></a>
          <a role="button" class="btn btn-secondary border-0 rounded-0 code-expandcollapse-btn" aria-label="expand or shrink" onclick="expandCollapseCode(this)" data-toggle="tooltip" data-placement="top" title="Expand/Shrink"><img class="btn-icon" src="/images/commons/icons/maximize.svg" /></a>
        </div>
      </div>
    </div>
  </div>
  <div class="card-body">
    <pre class="language-jq line-numbers code-collapsed code-copy"><code class="code-block">include "module-openapi";

# Available filters and their default values
# To be used with init_parameters
def default_filters:
{
  deprecated: null,
  method: null,
  code: null,
  scope: null,
  path_contains: null
};

# Filters operations coming from oas_operations
# Each filter is used only if corresponding filters.&#60;name&#62; parameter is provided
def filter_oas_operations(filters):
  map(
    select(
    # Filters on deprecated
    (filters.deprecated == null or 
      (.deprecated | tostring) == filters.deprecated) and
    # Filters on HTTP method
    (filters.method == null or 
      .method == filters.method) and
    # Filters on HTTP status code
    (filters.code == null or 
      (.original.responses | has(filters.code))) and
    # Filters on security scope
    (filters.scope == null or
      (if .value.security? != null then
        [ .value.security | 
          map(to_entries | 
          map(.value)[])[][]] | 
        index(filters.scope) &#62;= 0
      else
        false
      end)
    ) and
    # Filters on path
    (filters.path_contains == null or 
      (.path | contains(filters.path_contains))
    )
  )
);

# Same as oas_operations_to_text but with source
def oas_operations_to_text_with_source: 
  map( # Applies a transformation to each element
    "[" + .source[0:20] + "]\t" +
    .method + "\t" + 
    .path + "\t" + 
    .summary + 
    (if .deprecated then " (deprecated)" else "" end)
  )
  [] # Flattens array for raw output
; # oas_operations_to_text function's end

# To be used with init_parameters
def default_print_parameters:
{
  format: "text_with_source"
  # All values: 
  #  text_with_source, text_without_source, json_flat or null for json
};

# Prints oas_operations (filtered or not) in various format
def print_oas_operations(format):
  if format == "text_with_source" then
      oas_operations_to_text_with_source
  elif format == "text_without_source" then
      oas_operations_to_text
  elif format == "json_flat" then
    .[] # Flattening for multifiles, pipe result into a jq -s
  else
    .
  end
;

</code></pre>
  </div>
</div>

<h1 id="summary">Summary</h1>

<p>That concludes this second path of the JQ and OpenAPI series. Here’s the summary of what we have seen in this post:</p>

<h2 id="functions-and-modules">Functions and modules</h2>

<ul>
  <li>Creating a function is done with <code>def name: &lt;filters&gt;;</code></li>
  <li>To invoke a function just use its <code>name</code> like for any regular filter</li>
  <li>Functions can have parameters <code>def name(parameter)</code></li>
  <li>Inside a function a parameter can be used with <code>parameter</code> (without $)</li>
  <li>A module is a JQ file containing reusable functions</li>
  <li>A module is loaded using the <code>include filename_without_extension</code> directive</li>
  <li>Use <code>-L</code> command line parameter to tell JQ where to find modules</li>
  <li>Put your favorite modules in <code>~/.jq</code> folder so JQ can find them without using <code>-L</code></li>
</ul>

<h2 id="command-line-arguments">Command line arguments</h2>

<ul>
  <li>Passing a named argument to JQ filters is done with <code>--arg name value</code></li>
  <li>A named argument value can be retrieved with <code>$name</code></li>
  <li>Using <code>$name</code> will provoke an error if no <code>--arg name value</code> is provided</li>
  <li>All named arguments are available with <code>$ARGS.named</code></li>
  <li><code>$ARGS.named[name]</code> returns null (wihout error) if no <code>--arg name value</code> is provided</li>
</ul>

<h2 id="the-null-argument">The null argument</h2>

<ul>
  <li>The <code>-n</code> (<code>--null</code>) arguments tells JQ to not expect input JSON</li>
</ul>

<h2 id="new-filters">New filters</h2>

<table class="table-documentation-links">
  
  <thead>
    <tr>
      <th colspan="3" scope="col">JQ Filters</th>
    </tr>
  </thead>
  
  <tbody>



    <tr>
      <td><code>index(element)</code></td>
      <td>Returns the index of an element inside an array (-1 if not found)</td>
      <td><a class="btn-documentation" href="https://stedolan.github.io/jq/manual/v1.6/#index(s),rindex(s)" target="jq" aria-label="open documentation in a new tab" data-toggle="tooltip" data-placement="right" title="Open documentation in a new tab"><svg height="100px" width="100px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve"><path d="M19.5,2.4c-2.8-1.8-6.6-1.9-9.5-0.3C7.1,0.5,3.3,0.6,0.5,2.4L0,2.7V19l1.5-1c2.4-1.5,5.6-1.5,7.9,0l0.5,0.3  l0.5-0.3c2.4-1.5,5.6-1.5,7.9,0l1.5,1V2.7L19.5,2.4z M2,15.5V3.9c2.2-1.2,4.8-1.1,7,0v11.7c-1.1-0.4-2.3-0.7-3.5-0.7  C4.3,14.9,3.1,15.1,2,15.5z M18,15.5c-2.2-0.9-4.8-0.9-7,0V3.9c2.2-1.2,4.9-1.2,7,0V15.5z"></path></svg></a></td>
    </tr>


    <tr>
      <td><code>contains(element)</code><br /><code>"resources" | contains("source")
</code></td>
      <td>Returns true the element is in input</td>
      <td><a class="btn-documentation" href="https://stedolan.github.io/jq/manual/v1.6/#contains(element)" target="jq" aria-label="open documentation in a new tab" data-toggle="tooltip" data-placement="right" title="Open documentation in a new tab"><svg height="100px" width="100px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve"><path d="M19.5,2.4c-2.8-1.8-6.6-1.9-9.5-0.3C7.1,0.5,3.3,0.6,0.5,2.4L0,2.7V19l1.5-1c2.4-1.5,5.6-1.5,7.9,0l0.5,0.3  l0.5-0.3c2.4-1.5,5.6-1.5,7.9,0l1.5,1V2.7L19.5,2.4z M2,15.5V3.9c2.2-1.2,4.8-1.1,7,0v11.7c-1.1-0.4-2.3-0.7-3.5-0.7  C4.3,14.9,3.1,15.1,2,15.5z M18,15.5c-2.2-0.9-4.8-0.9-7,0V3.9c2.2-1.2,4.9-1.2,7,0V15.5z"></path></svg></a></td>
    </tr>


    <tr>
      <td><code>$ARGS.named</code></td>
      <td>Returns the command line named argument (--arg name value)</td>
      <td><a class="btn-documentation" href="https://stedolan.github.io/jq/manual/v1.6/#Invokingjq" target="jq" aria-label="open documentation in a new tab" data-toggle="tooltip" data-placement="right" title="Open documentation in a new tab"><svg height="100px" width="100px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve"><path d="M19.5,2.4c-2.8-1.8-6.6-1.9-9.5-0.3C7.1,0.5,3.3,0.6,0.5,2.4L0,2.7V19l1.5-1c2.4-1.5,5.6-1.5,7.9,0l0.5,0.3  l0.5-0.3c2.4-1.5,5.6-1.5,7.9,0l1.5,1V2.7L19.5,2.4z M2,15.5V3.9c2.2-1.2,4.8-1.1,7,0v11.7c-1.1-0.4-2.3-0.7-3.5-0.7  C4.3,14.9,3.1,15.1,2,15.5z M18,15.5c-2.2-0.9-4.8-0.9-7,0V3.9c2.2-1.2,4.9-1.2,7,0V15.5z"></path></svg></a></td>
    </tr>

  </tbody>
</table>

<h1 id="whats-next">What’s next</h1>

<p>In next post, we’ll learn to modify OpenAPI files with JQ.</p>
:ET